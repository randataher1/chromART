<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Profile</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">

    <link href="css/ratchet.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/jumbotron-narrow.css" rel="stylesheet">

    <link href="css/chromart.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <!--<script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>-->


  </head>

  <body>

    <div class="container">
      <div class="pageHeader">
      </div>

      <div class="profileContainer">
        <div class="row">
          <div class="col-xs-4" id="proPic">
            Profile Picture
          </div>
          <div class="col-xs-8">
            <div class="row" id="proName">
              Username
            </div>
            <div class="row" id="proDescription">
              Description
            </div>
            <div class="row" id="proContact">
              <div class="col-xs-1 col-xs-offset-5">
                Facebook
              </div>
              <div class="col-xs-1">
                Twitter
              </div>
              <div class="col-xs-1">
                Email
              </div>
            </div>
          </div>
        </div>

        <div id="proFollowButton">
          
        </div>

        <div id="proFollowInfo">
          
        </div>

        <div id="proGalleries">

        </div>
      </div>

      <div>
        <button type="button" class="btn btn-default logout">Logout</button>
      </div>

      <div class="clear"></div>

      <div>
        <nav class="bar bar-tab">
          <a class="tab-item" href="home.html">
            <span class="icon icon-home"></span>
            <span class="tab-label">Home</span>
          </a>
          <a class="tab-item active" href="profile.html">
            <span class="icon icon-person"></span>
            <span class="tab-label">Profile</span>
          </a>
          <a class="tab-item" href="explore.html">
            <span class="icon icon-pages"></span>
            <span class="tab-label">Explore</span>
          </a>
          <a class="tab-item" href="upload.html">
            <span class="icon icon-share"></span>
            <span class="tab-label">Upload</span>
          </a>
        </nav>
      </div>

    </div> <!-- /container -->


  <script type="text/javascript">
    Parse.initialize("OmBCFAsCIuhnhzrCLtvKyGIdxQHYBW89XS3QqkvP", "mQK3VkWpDgGHoxDH0kroP1UFd7WPUbm0ZT2vzf21");

    var $_GET = {};
    if(document.location.toString().indexOf('?') !== -1) {
        var query = document.location
                       .toString()
                       // get the query string
                       .replace(/^.*?\?/, '')
                       // and remove any existing hash string (thanks, @vrijdenker)
                       .replace(/#.*$/, '')
                       .split('&');

        for(var i=0, l=query.length; i<l; i++) {
           var aux = decodeURIComponent(query[i]).split('=');
           $_GET[aux[0]] = aux[1];
        }
    }

    // set userID to the user id we get from the get variable
    if ($_GET['userID']) {
        userID = $_GET['userID'];
    }
    // handle profile.html case with the current logged in user
    else { 
        userID = Parse.User.current().id; // where User was previously set by the parse User object
    }

    var otherUserObject;

    //Adding content to profile based on userID
    var otherUser = Parse.Object.extend("_User");
    var userQuery = new Parse.Query(otherUser);
    userQuery.get(userID, {
      success: function(other) {
        // The object was retrieved successfully.
        var picture = other.get("profilePictureUrl");
        var name = other.get("username");
        var desc = other.get("profileDescription");
        document.getElementById('proPic').innerHTML = "<img src=\"" + picture + "\" class=\"img-circle profilePicture\"/>";
        document.getElementById('proName').innerHTML = name;
        document.getElementById('proDescription').innerHTML = desc;
        otherUserObject = other;
        //If userID is not that of current user, check if current user is following the user with that userID
        if(userID != Parse.User.current().id) {
          var following = Parse.Object.extend("Follow");
          var followingQuery = new Parse.Query(following);
          //Look for an existing Follow object that points to current user and the other user
          followingQuery.equalTo("user", Parse.User.current());
          followingQuery.equalTo("followedUser", otherUserObject);
          followingQuery.find({
            success: function(results) {
              //If there is a following object, appends an active button
              if(results.length === 0) {
                $("#proFollowButton").append("<button type=\"button\" class=\"btn blueButton\"" +
                  "id=\"followButton\">Follow</button>");
              }
              //If there isn't, appends a non-active button
              else {
                $("#proFollowButton").append("<button type=\"button\" class=\"btn blueButton active\"" +
                  "id=\"followButton\">Following</button>");
              }

              //Adds follow functionality to button
              $("#followButton").click(function() {
                if($("#followButton").hasClass("active")) {
                  $("#followButton").removeClass("active");
                  document.getElementById("followButton").innerHTML="Follow";
                  var following = Parse.Object.extend("Follow");
                  var followingQuery = new Parse.Query(following);
                  //Look for an existing Follow object that points to current user and the other user
                  followingQuery.equalTo("user", Parse.User.current());
                  followingQuery.equalTo("followedUser", otherUserObject);
                  //Deletes Follow object if user deselects the Follow button
                  followingQuery.find({
                    success: function(results) {
                      results[0].destroy({});
                    },
                    error: function(object, error) {
                      alert("Failed to find Follow object");
                    }
                  });
                }
                else {
                  $("#followButton").addClass("active");
                  document.getElementById("followButton").innerHTML="Following";
                  //Creates new Follow object if user selects the Follow button
                  var Follow = Parse.Object.extend("Follow");
                  var follow = new Follow();
                  follow.set("user", Parse.User.current());
                  follow.set("followedUser", otherUserObject);
                  follow.save(null, {
                    success: function(object) {
                      alert("Success!");
                    },
                    error: function(object, error) {
                      alert("Failed to create new Follow object");
                    }
                  });
                }
              });
            },
            error: function(error) {
              alert("No Follow object that points to these users");
            }
          });
        }
      },
      error: function(object, error) {
        // The object was not retrieved successfully.
        // error is a Parse.Error with an error code and description.
        alert("User load error");
      }
    });

    //Finding galleries based on userID and adding to profile
    var otherGallery = Parse.Object.extend("Gallery");
    var galleryQuery = new Parse.Query(otherGallery);
    galleryQuery.equalTo("userId", userID);
    galleryQuery.find({
      success: function(results) {
        // The object was retrieved successfully.
        for(var i = 0; i < results.length; i++) {
          var object = results[i];
          $("#galleries").append("<p>" + object.get('name') + "</p>");
        }
      },
      error: function(error) {
        // The object was not retrieved successfully.
        // error is a Parse.Error with an error code and description.
        alert("User load error");
      }
    });

    //If userID is that of current user, add Settings bar
    if(userID === Parse.User.current().id) {
      $(".pageHeader").append("Settings");
    }

    $(".logout").click(function() {
      Parse.User.logOut();
      window.location.href = 'index.html';
    });
  </script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
  </body>
</html>
