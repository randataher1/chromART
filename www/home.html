<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Home</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">

    <link href="css/ratchet.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/jumbotron-narrow.css" rel="stylesheet">

    <link href="css/chromart.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <!--<script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>-->


  </head>

  <body>

    <div class="container">
      <div class="pageHeader">
        <img src="img/logo.png" class="logo center" />
      </div>


      <div class="imageScroll">
        <div class="image">
          <div class="row">
            <div class="col-sm-12">
              Image
              <div class="row">
                <div class="col-xs-3">
                  Profile Picture
                </div>
                <div class="col-xs-5">
                  <div class="row">
                    Username
                  </div>
                  <div class="row">
                    Description
                  </div>
                  <div class="row">
                    Hashtags
                  </div>
                </div>
                <div class="col-xs-2">
                  <button type="button" class="btn btn-default btn-sm like">
                    <span class="glyphicon glyphicon-thumbs-up"></span>
                  </button>
                </div>
                <div class="col-xs-1">
                  <button type="button" class="btn btn-default btn-sm dislike">
                    <span class="glyphicon glyphicon-thumbs-down"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <button type="button" class="btn btn-default logout">Logout</button>
      </div>

      <div class="clear"></div>

      <div>
        <nav class="bar bar-tab">
          <a class="tab-item active" href="home.html">
            <span class="icon icon-home"></span>
            <span class="tab-label">Home</span>
          </a>
          <a class="tab-item" href="profile.html?userID=">
            <span class="icon icon-person"></span>
            <span class="tab-label">Profile</span>
          </a>
          <a class="tab-item" href="explore.html">
            <span class="icon icon-pages"></span>
            <span class="tab-label">Explore</span>
          </a>
          <a class="tab-item" href="upload.html">
            <span class="icon icon-share"></span>
            <span class="tab-label">Upload</span>
          </a>
        </nav>
      </div>

    </div> <!-- /container -->


<script type="text/javascript">
    Parse.initialize("Og5SrfaWadYcXArMTgGM1gJwHy750LoBtJVRV0JA", "aCd8Z5xLTOomMPazIG4i8z691PncoCBnKjW5iL1u");

    //Finding all Follow objects of the current user
    var Follow = Parse.Object.extend("Follow");
    var followQuery = new Parse.Query(Follow);
    followQuery.equalTo("user", Parse.User.current());
    followQuery.include('user');
    followQuery.find({
      success: function(followResults) {
        // The object was retrieved successfully.
        //Loops through most recently created images of followed users and adds them to the page
        var followObjects = [];
        $.each(followResults, function(object, user) {
          followObjects[object] = user.get('followedUser');
        });
        console.log(followObjects);
        var Img = Parse.Object.extend("Image");
        var imageQuery = new Parse.Query(Img);
        imageQuery.descending("createdAt");
        imageQuery.include('user');
        imageQuery.containedIn("user", followObjects);
        imageQuery.find({
          success: function(imageResults) {
            // The object was retrieved successfully.
            for(var j = 0; j < imageResults.length; j++) {
              var imageObject = imageResults[j];
              var userObject = imageObject.get('user');
              $(".imageScroll").append(
                "<div class=\"image\">" +
                  "<div class=\"row\">" +
                    "<div class=\"col-sm-12\">" +
                    "<img class=\"imageResize\" src=\"" + imageObject.get('url') + "\" />" +
                    "<div class=\"row\">" +
                      "<div class=\"col-xs-3\"><a href=\"profile.html?userID=" +
                      userObject.id +"\">" + 
                      "<img class=\"img-circle imageProfilePicture\" src=\"" +
                        userObject.get('profilePictureUrl') +
                      "\" />" +
                      "</a></div>" +
                        "<div class=\"col-xs-5\">" +
                          "<div class=\"row\"><a href=\"profile.html?userID=" +
                            userObject.id + "\">" + userObject.get('username') +
                          "</a></div>" +
                          "<div class=\"row\">" +
                            imageObject.get('description') +
                          "</div>" +
                          "<div class=\"row\">" +
                            imageObject.get('hashtag') +
                          "</div>" +
                        "</div>" +
                        "<div class=\"col-xs-2\">" +
                          "<button type=\"button\" id=\"imageLike" + j +
                          "\" class=\"btn btn-default btn-sm like\">" +
                            "<span class=\"glyphicon glyphicon-thumbs-up\"></span>" +
                          "</button>" +
                        "</div>" +
                        "<div class=\"col-xs-1\">" +
                          "<button type=\"button\" id=\"imageDislike" + j +
                          "\" class=\"btn btn-default btn-sm\">" +
                            "<span class=\"glyphicon glyphicon-thumbs-down\"></span>" +
                          "</button>" +
                        "</div>" +
                      "</div>" +
                    "</div>" +
                  "</div>" +
                "</div>");

              var imageLikeObject = Parse.Object.extend("ImageLike");
              var imageLikeQuery = new Parse.Query(imageLikeObject);
              //Look for an existing ImageLike object that points to current user and the image
              imageLikeQuery.equalTo("user", Parse.User.current());
              imageLikeQuery.equalTo("image", imageObject);
              imageLikeQuery.find({
                success: function(results) {
                  //If there is, alerts user
                  if(results.length === 0) {
                    $("#proFollowButton").append("<button type=\"button\" class=\"btn blueButton\"" +
                      "id=\"followButton\">Follow</button>");
                  }
                  //If there isn't, alert user
                  else {
                    alert("There is a like or dislike");
                  }

                  //Adds like functionality to button
                  $("#imageLike").click(function() {
                    //If the Like button is already selected
                    if($("#imageLike").hasClass("active")) {
                      $("#imageLike").removeClass("active");
                      var imageLikeObject = Parse.Object.extend("ImageLike");
                      var imageLikeQuery = new Parse.Query(imageLikeObject);
                      //Look for an existing ImageLike object that points to current user and the image
                      imageLikeQuery.equalTo("user", Parse.User.current());
                      imageLikeQuery.equalTo("image", imageObject);
                      //Deletes ImageLike object if user deselects the Like button
                      imageLikeQuery.find({
                        success: function(results) {
                          results[0].destroy({});
                        },
                        error: function(object, error) {
                          alert("Failed to find Like object");
                        }
                      });
                    }
                    //If the Like button is not selected
                    else {
                      $("#followButton").addClass("active");
                      document.getElementById("followButton").innerHTML="Following";
                      //Creates new Follow object if user selects the Follow button
                      var Follow = Parse.Object.extend("Follow");
                      var follow = new Follow();
                      follow.set("user", Parse.User.current());
                      follow.set("followedUser", otherUserObject);
                      follow.save(null, {
                        success: function(object) {
                          alert("Success!");
                        },
                        error: function(object, error) {
                          alert("Failed to create new Follow object");
                        }
                      });
                    }
                  });
                },
                error: function(error) {
                  alert("No Follow object that points to these users");
                }
              });
            }
          },
          error: function(object, error) {
            alert("Error");
          }
        });
      },
      error: function(error) {
        // The object was not retrieved successfully.
        // error is a Parse.Error with an error code and description.
        alert("Error retrieving images");
      }
    });
    
    $(".logout").click(function() {
      Parse.User.logOut();
      window.location.href = 'index.html';
    });
  </script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
  </body>
</html>
